<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cocina - Cangre Burger</title>
    <link href="/dist/output.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .order-card {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .order-card.removing {
            animation: fadeOut 0.5s ease-in-out forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: scale(0.9);
            }
        }

        .highlight-flash {
            animation: flash 1s ease-in-out;
        }

        @keyframes flash {
            0%, 100% { background-color: #374151; } /* bg-gray-700 */
            50% { background-color: #d97706; } /* bg-amber-600 */
        }
    </style>
</head>

<body class="bg-gray-800 text-white p-4">
    <script>
        // Mover la verificación del token al inicio del body para una redirección inmediata.
        const token = localStorage.getItem('cangre_burger_token');
        if (!token) {
            window.location.href = '/login.html';
        }
    </script>
    <a href="/dashboard" class="absolute top-4 right-4 text-blue-300 hover:text-white hover:underline text-sm">&larr; Volver al Dashboard</a>
    <header class="text-center mb-6">
        <h1 class="text-4xl font-bold text-amber-400">Órdenes de Cocina</h1>
        <div id="status-indicator" class="mt-2 text-sm font-semibold bg-red-500 text-white py-1 px-3 rounded-full inline-block cursor-pointer">Desconectado (Click para activar sonido)</div>
    </header>

    <main id="orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        <!-- Las órdenes aparecerán aquí -->
    </main>

    <audio id="notification-sound" src="https://static.whatsapp.net/rsrc.php/yW/r/BS_BUUXbKq5.mp3" preload="auto"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({
            auth: {
                token: token
            }
        });

        // --- DOM Elements ---
        const ordersContainer = document.getElementById('orders-container');
        const notificationSound = document.getElementById('notification-sound');
        const statusIndicator = document.getElementById('status-indicator');

        function renderOrderCard(order) {
            // Evita duplicar una tarjeta si ya existe (por si acaso)
            if (document.getElementById(`order-card-${order.id}`)) return;

            const orderCard = document.createElement('div');
            orderCard.className = 'order-card bg-gray-700 rounded-lg p-4 shadow-lg flex flex-col';
            orderCard.id = `order-card-${order.id}`;

            // Diferenciar entre items ya servidos (en una tanda anterior) y los nuevos.
            // Por defecto, en una orden nueva, todos los items son 'nuevos'.
            let itemsHtml = order.items.map(item => {
                let sauceLine = '';
                if (item.sauces && item.sauces.length > 0) {
                    sauceLine = `<div class="text-xs text-amber-300 pl-5">- Cremas: ${item.sauces.join(', ')}</div>`;
                }
                // Los items nuevos se resaltan.
                return `<li class="text-gray-100 font-semibold">${item.quantity}x ${item.name}</li>${sauceLine}`;
            }).join('');

            // Si la orden es una adición, el nombre del cliente lo indicará.
            const customerName = order.is_addition 
                ? `${order.customer_name} <span class="text-amber-400 font-normal">(Adición)</span>`
                : order.customer_name;

            let notesHtml = '';
            if (order.notes) {
                notesHtml = `
                    <div class="pt-2 mt-2 border-t border-gray-600">
                        <h4 class="font-semibold text-amber-400">Notas:</h4>
                        <p class="text-sm text-gray-400 whitespace-pre-wrap">${order.notes}</p>
                    </div>
                `;
            }

            orderCard.innerHTML = `
                <div class="flex-grow">
                    <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                        <h3 class="text-xl font-bold text-white">Cliente: ${customerName}</h3>
                        <span class="text-xs text-gray-400">${new Date(order.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <ul class="list-disc list-inside mt-2">${itemsHtml}</ul>
                    ${notesHtml}
                </div>
                <div class="mt-4">
                    <button onclick="markAsReady(${order.id})" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Listo
                    </button>
                </div>
            `;

            ordersContainer.prepend(orderCard);
        }

        async function loadPendingOrders() {
            try {
                const response = await fetch('/api/orders/pending', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    // Si el token es inválido o el rol no es correcto, el servidor devolverá un error.
                    if (response.status === 401 || response.status === 403) { // Unauthorized or Forbidden
                        window.location.href = '/login.html';
                        return;
                    }
                    throw new Error('No se pudieron cargar las órdenes pendientes.');
                }
                const pendingOrders = await response.json();
                ordersContainer.innerHTML = ''; // Limpiar contenido previo
                pendingOrders.forEach(order => renderOrderCard(order));
            } catch (error) {
                console.error(error);
                ordersContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">${error.message}</p>`;
            }
        }

        // --- Socket Event Listeners ---
        socket.on('connect_error', (err) => {
            // Manejar errores de autenticación del socket
            console.error('Error de conexión de Socket:', err.message);
            statusIndicator.textContent = 'Error de Conexión. Recargue la página.';
            statusIndicator.classList.add('bg-red-500');
        });

        socket.on('new_order', (order) => {
            notificationSound.play();
            renderOrderCard(order);
        });

        socket.on('new_addition', (addition) => {
            notificationSound.play();
            const existingCard = document.getElementById(`order-card-${addition.orderId}`);
            if (existingCard) {
                // Marcar los items existentes como servidos
                existingCard.querySelectorAll('ul li').forEach(li => {
                    li.classList.remove('text-gray-100', 'font-semibold');
                    li.classList.add('text-gray-400', 'line-through');
                });

                // Añadir los nuevos items resaltados
                const itemsList = existingCard.querySelector('ul');
                const newItemsHtml = addition.newItems.map(item => {
                    let sauceLine = '';
                    if (item.sauces && item.sauces.length > 0) {
                        sauceLine = `<div class="text-xs text-amber-300 pl-5">- Cremas: ${item.sauces.join(', ')}</div>`;
                    }
                    return `<li class="text-gray-100 font-semibold text-amber-300">${item.quantity}x ${item.name} (NUEVO)</li>${sauceLine}`;
                }).join('');

                itemsList.insertAdjacentHTML('beforeend', newItemsHtml);
                existingCard.classList.add('highlight-flash');
                setTimeout(() => existingCard.classList.remove('highlight-flash'), 1000);
            }
        });

        function markAsReady(orderId) {
            socket.emit('mark_order_ready', orderId);
        }

        socket.on('remove_order', (orderId) => {
            const cardToRemove = document.getElementById(`order-card-${orderId}`);
            if (cardToRemove) {
                cardToRemove.classList.add('removing');
                setTimeout(() => {
                    cardToRemove.remove();
                }, 500); // Espera a que termine la animación
            }
        });

        // --- Initialization on User Interaction ---
        function initializeKitchen(event) {
            // Prevenir que el evento se propague si no es necesario
            if (event) event.preventDefault();

            // Change status indicator
            statusIndicator.textContent = 'Conectado y esperando órdenes...';
            statusIndicator.classList.remove('bg-red-500', 'cursor-pointer');
            statusIndicator.classList.add('bg-green-500');

            // Intentar reproducir un sonido silencioso para "desbloquear" el audio
            notificationSound.play().catch(e => console.warn("La reproducción automática de audio fue bloqueada por el navegador. Se activará con la primera orden."));

            loadPendingOrders();

            // Remover el listener para que no se pueda hacer clic de nuevo
            statusIndicator.removeEventListener('click', initializeKitchen);
        }

        // The listener runs only once after the first click.
        statusIndicator.addEventListener('click', initializeKitchen);
    </script>
</body>

</html>